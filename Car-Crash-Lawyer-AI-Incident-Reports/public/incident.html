<!-- Add this in incident.html -->
<!-- Include html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  window.addEventListener('load', async () => {
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
    await delay(2000); // wait for W3W map section to load

    const target = document.querySelector('#w3w-section');
    if (!target) return;

    html2canvas(target).then(async canvas => {
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      const filename = `w3w_map_${Date.now()}.png`;
      const storage = firebase.storage();
      const db = firebase.firestore();

      const imgRef = storage.ref().child(`w3w_maps/${filename}`);
      await imgRef.put(blob);
      const downloadURL = await imgRef.getDownloadURL();

      const userId = new URLSearchParams(window.location.search).get('user_id');
      if (!userId) return;

      const incidentDocRef = db.collection('Car Crash Lawyer AI Incident Reports').doc(userId);
      await incidentDocRef.update({
        user_id_hidden_field: userId,
        what3words_location: document.querySelector('#w3w-text')?.innerText || '',
        what3words_map_image: downloadURL,
        updated: new Date()
      });

      console.log('‚úÖ What3Words image and location saved to main incident report');
    });
  });
</script>

<!-- HTML Structure -->
<div id="w3w-section">
  <div><strong>üìç Full Address:</strong><br>Priory Drive, Forest Hall Park, Stansted Mountfitchet, Essex, England, CM2</div>
  <div id="w3w-text" style="background:#e53935;color:white;padding:10px;margin:10px 0;">
    ///swims.bumpy.blazed
  </div>
  <div id="map" style="height:200px;width:100%;background:#ccc;"></div>
</div>











