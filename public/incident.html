<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Crash Lawyer AI - Report Incident</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .glass-effect {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 via-indigo-800 to-blue-600 flex items-center justify-center py-10">
  <div class="w-full max-w-3xl mx-auto space-y-8">

    <!-- Header Card -->
    <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-xl p-8 flex flex-col items-center">
      <img src="logo.png" alt="Car Crash Lawyer AI Logo" class="h-16 mb-2 rounded-xl shadow-md" />
      <h1 class="text-4xl font-extrabold text-blue-900 tracking-tight mb-1 flex items-center">
        <span class="mr-2">üöó</span>Report Incident
      </h1>
      <p class="text-indigo-800 text-base text-center opacity-90 font-medium">Secure, AI-powered incident documentation</p>
    </div>

    <!-- Find/Record Buttons Group -->
    <div class="flex flex-wrap gap-3 justify-center items-center">
      <button id="findMeBtn" class="transition-all duration-200 bg-gradient-to-r from-blue-600 to-sky-400 hover:from-blue-700 hover:to-sky-500 text-white font-bold text-lg px-6 py-3 rounded-xl shadow-md focus:outline-none focus:ring-2 focus:ring-sky-400">
        üìç Find Me!
      </button>
      <button id="startWhisper" class="bg-teal-600 hover:bg-teal-700 text-white font-bold px-5 py-3 rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-teal-300">
        Activate Whisper Voice Transcription
      </button>
      <button id="skipWhisper" class="bg-pink-500 hover:bg-pink-700 text-white font-bold px-5 py-3 rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-pink-300">
        No Voice Recording
      </button>
    </div>
    <div id="recStatus" class="text-center text-lg font-semibold h-7 transition-all duration-200"></div>

    <!-- Location Card -->
    <div id="locationContainer" class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-lg p-7" style="display:none;">
      <h2 class="text-2xl font-bold text-blue-800 mb-5 flex items-center">
        <span class="mr-2">üìç</span>Incident Location
      </h2>
      <div class="flex flex-col gap-4">
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <div id="what3wordsDisplay" class="flex-1 rounded-xl bg-gradient-to-r from-red-500 to-orange-400 text-white text-center p-4 font-bold text-xl shadow-md">
            <div class="text-xs opacity-80 tracking-wide">what3words location:</div>
            <div id="what3wordsText" class="mt-1 text-2xl tracking-wider">///loading.location.words</div>
          </div>
          <div class="flex-1 flex justify-center items-center">
            <div id="map" class="rounded-lg shadow border border-sky-200 w-full min-w-[230px] max-w-[350px] h-[230px]"></div>
          </div>
        </div>
        <div class="flex flex-col md:flex-row gap-4 mt-3">
          <div class="flex-1">
            <label for="latitude" class="text-sm text-blue-900 font-semibold">Latitude:</label>
            <input id="latitude" type="text" readonly class="w-full p-2 rounded-md border border-gray-200 bg-sky-50 text-blue-900 font-bold" />
          </div>
          <div class="flex-1">
            <label for="longitude" class="text-sm text-blue-900 font-semibold">Longitude:</label>
            <input id="longitude" type="text" readonly class="w-full p-2 rounded-md border border-gray-200 bg-sky-50 text-blue-900 font-bold" />
          </div>
        </div>
        <div class="flex flex-col mt-3">
          <label for="fullAddressText" class="text-sm text-blue-900 font-semibold">Full Address:</label>
          <div class="flex items-center gap-2">
            <input id="fullAddressText" type="text" readonly class="flex-1 p-2 rounded-md border border-gray-200 bg-blue-50 text-blue-800 font-semibold shadow-sm" />
            <button type="button" onclick="copyAddress()" class="p-2 bg-blue-500 hover:bg-blue-700 text-white rounded-md font-bold text-xs focus:ring-2 focus:ring-blue-300" aria-label="Copy full address">Copy</button>
          </div>
        </div>
        <div class="location-accuracy bg-green-500 text-white text-center py-2 px-4 rounded-md font-semibold shadow mt-2" id="accuracyInfo" aria-live="polite">
          <span>Location Accuracy:</span> <span id="accuracyValue">Unknown</span>
        </div>
      </div>
    </div>

    <!-- Incident Form Card -->
    <div class="glass-effect p-6 mb-6 rounded-2xl shadow-xl bg-white/70">
      <h2 class="text-2xl font-bold text-blue-800 mb-6 flex items-center">üìù Incident Details</h2>
      <form id="incidentForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="vehicleMake" class="block text-sm font-medium text-blue-900 mb-1">Vehicle Make</label>
            <input type="text" id="vehicleMake" name="vehicleMake" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Toyota">
          </div>
          <div>
            <label for="vehicleModel" class="block text-sm font-medium text-blue-900 mb-1">Vehicle Model</label>
            <input type="text" id="vehicleModel" name="vehicleModel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Camry">
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="driverName" class="block text-sm font-medium text-blue-900 mb-1">Driver Name</label>
            <input type="text" id="driverName" name="driverName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Your full name">
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-blue-900 mb-1">Email Address</label>
            <input type="email" id="email" name="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="your.email@example.com">
          </div>
        </div>

        <div>
          <label for="incidentDescription" class="block text-sm font-medium text-blue-900 mb-1">Incident Description</label>
          <textarea id="incidentDescription" name="incidentDescription" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Please describe what happened..."></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="incidentDate" class="block text-sm font-medium text-blue-900 mb-1">Incident Date</label>
            <input type="date" id="incidentDate" name="incidentDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label for="incidentTime" class="block text-sm font-medium text-blue-900 mb-1">Incident Time</label>
            <input type="time" id="incidentTime" name="incidentTime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>

        <div>
          <label for="otherParties" class="block text-sm font-medium text-blue-900 mb-1">Other Parties Involved</label>
          <textarea id="otherParties" name="otherParties" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Names, contact info, insurance details of other parties..."></textarea>
        </div>

        <div>
          <label for="witnesses" class="block text-sm font-medium text-blue-900 mb-1">Witnesses</label>
          <textarea id="witnesses" name="witnesses" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Witness contact information..."></textarea>
        </div>

        <div>
          <label for="policeReport" class="block text-sm font-medium text-blue-900 mb-1">Police Report Number (if applicable)</label>
          <input type="text" id="policeReport" name="policeReport" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Police report reference number">
        </div>

        <div class="flex items-center space-x-2">
          <input type="checkbox" id="consent" name="consent" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
          <label for="consent" class="text-sm text-blue-900">I consent to processing of this incident report data</label>
        </div>

        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-sky-500 hover:from-blue-700 hover:to-sky-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500">
          üöÄ Submit Incident Report
        </button>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, marker, accuracyCircle, userLocation = null;
    let recorder, audioChunks = [], audioBlob = null, whisperActive = false;

    // FIND ME BUTTON
    document.getElementById('findMeBtn').onclick = function() {
      const loading = document.getElementById('loadingSpinner');
      const locationContainer = document.getElementById('locationContainer');
      const locationInfo = document.getElementById('locationInfo');
      locationContainer.style.display = 'block';
      if (loading) loading.style.display = 'block';
      if (locationInfo) locationInfo.style.display = 'none';

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude, accuracy = pos.coords.accuracy;
        userLocation = { lat, lng, accuracy };

        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);

        let accText = `¬±${Math.round(accuracy)}m`;
        let accColor = '#22c55e';
        if (accuracy > 50) accColor = '#f59e42';
        if (accuracy > 100) accColor = '#f87171';
        document.getElementById('accuracyValue').textContent = accText;
        document.getElementById('accuracyInfo').style.background = accColor;

        // Center & create map
        if (!map) {
          map = L.map('map').setView([lat, lng], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        if (marker) marker.remove();
        marker = L.marker([lat, lng]).addTo(map).bindPopup('Incident Location').openPopup();
        if (accuracyCircle) accuracyCircle.remove();
        accuracyCircle = L.circle([lat, lng], {
          radius: accuracy,
          fillColor: accColor,
          color: accColor,
          fillOpacity: 0.13,
          weight: 1
        }).addTo(map);

        // Show info, hide spinner
        if (locationInfo) locationInfo.style.display = 'block';
        if (loading) loading.style.display = 'none';

        // what3words
        try {
          const resp = await fetch(`/api/what3words?lat=${lat}&lng=${lng}`);
          const data = await resp.json();
          document.getElementById('what3wordsText').textContent = data.words ? `///${data.words}` : '///error.getting.words';
        } catch {
          document.getElementById('what3wordsText').textContent = '///error.getting.words';
        }

        // Address (OpenStreetMap Nominatim)
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
          const result = await response.json();
          document.getElementById('fullAddressText').value = result.display_name || '';
        } catch {
          document.getElementById('fullAddressText').value = 'Unable to fetch address';
        }
      }, (err) => {
        if (loading) loading.style.display = 'none';
        alert('Unable to get your location. Please enable location access.');
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 });
    };

    // Copy address for accessibility
    function copyAddress() {
      const el = document.getElementById('fullAddressText');
      el.select();
      el.setSelectionRange(0, 99999);
      document.execCommand('copy');
      el.blur();
      el.classList.add('ring', 'ring-green-400');
      setTimeout(()=>el.classList.remove('ring','ring-green-400'), 700);
    }

    // Whisper Voice Recording
    document.getElementById('startWhisper').onclick = async () => {
      if (recorder && recorder.state === 'recording') return;
      audioChunks = [];
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => audioChunks.push(e.data);
      recorder.onstart = () => {
        whisperActive = true;
        document.getElementById('recStatus').textContent = 'üéôÔ∏è Recording... Speak now. Recording will stop on submit.';
      };
      recorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        document.getElementById('recStatus').textContent = 'üéôÔ∏è Recording captured! Ready to submit.';
        whisperActive = false;
      };
      recorder.start();
    };

    document.getElementById('skipWhisper').onclick = () => {
      if (recorder && recorder.state === 'recording') {
        recorder.stop();
      }
      document.getElementById('recStatus').textContent = 'Voice recording skipped.';
      whisperActive = false;
      audioBlob = null;
    };

    // Form submission: attach audio
    document.getElementById('incidentForm').addEventListener('submit', async function(e) {
      if (recorder && recorder.state === 'recording') {
        await new Promise(resolve => {
          recorder.onstop = resolve;
          recorder.stop();
        });
      }
      const formData = new FormData(this);
      if (audioBlob) {
        formData.append('audio', audioBlob, 'recording.webm');
      }
      try {
        const response = await fetch('/api/incident-report', {
          method: 'POST',
          body: formData
        });
        if (response.ok) {
          alert('‚úÖ Incident report submitted successfully! You will receive an email with your report shortly.');
          window.location.href = 'index.html';
        } else {
          const errorData = await response.text();
          throw new Error(errorData);
        }
      } catch (error) {
        console.error('Error submitting report:', error);
        alert('‚ùå Failed to submit report. Please try again.');
      }
    });
  </script>
</body>
</html>













