<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Find My Location & Voice ‚Äì Car Crash Lawyer AI</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { background: #eceffc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .container { max-width: 500px; margin: 60px auto; padding: 24px; background: #fff; border-radius: 10px; box-shadow: 0 6px 24px rgba(0,0,0,0.08);}
    #map { height: 250px; border-radius: 6px; margin: 12px 0; }
    .w3w { font-size: 1.2rem; font-weight: bold; color: #e74c3c; }
    .rec-status { margin-top: 10px; color: #1e8449; font-size: 1rem;}
    .btn { padding: 12px 20px; font-size: 1rem; border-radius: 8px; border: none; margin: 5px;}
    .btn-record { background: #007acc; color: #fff;}
    .btn-skip { background: #aaa; color: #fff;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Find My Location</h1>
    <button id="findBtn" class="btn">üìç Find Me!</button>
    <div id="result" style="display:none;">
      <div id="map"></div>
      <div class="w3w" id="w3w"></div>
      <div>Lat: <span id="lat"></span> | Lng: <span id="lng"></span></div>
    </div>
    <hr style="margin:24px 0;">
    <h2>Optional: Record a Voice Note</h2>
    <button id="startWhisper" class="btn btn-record">Activate Whisper Voice Transcription</button>
    <button id="skipWhisper" class="btn btn-skip">No Voice Recording</button>
    <div id="recStatus" class="rec-status"></div>

    <form id="finalForm">
      <input type="hidden" name="latitude" id="hiddenLat">
      <input type="hidden" name="longitude" id="hiddenLng">
      <input type="hidden" name="what3words" id="hiddenW3w">
      <!-- Add other hidden or visible fields as needed -->
      <button type="submit" class="btn btn-record" style="margin-top:24px;">Submit</button>
    </form>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --------- WHAT3WORDS/LOCATION SECTION -------------
    let map, marker, userLat, userLng;
    document.getElementById('findBtn').onclick = async () => {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        document.getElementById('lat').textContent = userLat.toFixed(6);
        document.getElementById('lng').textContent = userLng.toFixed(6);
        document.getElementById('hiddenLat').value = userLat;
        document.getElementById('hiddenLng').value = userLng;
        document.getElementById('result').style.display = 'block';
        if (!map) {
          map = L.map('map').setView([userLat, userLng], 17);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        if (marker) marker.remove();
        marker = L.marker([userLat, userLng]).addTo(map).bindPopup('You are here').openPopup();

        // What3Words API call (update to your backend endpoint if needed)
        const resp = await fetch(`/api/what3words?lat=${userLat}&lng=${userLng}`);
        const data = await resp.json();
        document.getElementById('w3w').textContent = data.words ? `///${data.words}` : '///error.getting.words';
        document.getElementById('hiddenW3w').value = data.words ? data.words : '';
      }, (err) => alert('Unable to find location!'));
    };

    // --------- WHISPER SECTION -------------
    let recorder, audioChunks = [], audioBlob = null, whisperActive = false;

    document.getElementById('startWhisper').onclick = async () => {
      if (recorder && recorder.state === 'recording') return; // Already recording
      audioChunks = [];
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => audioChunks.push(e.data);
      recorder.onstart = () => {
        whisperActive = true;
        document.getElementById('recStatus').textContent = 'üéôÔ∏è Recording... Speak now. Recording will stop on submit.';
      };
      recorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        document.getElementById('recStatus').textContent = 'üéôÔ∏è Recording captured! Ready to submit.';
        whisperActive = false;
      };
      recorder.start();
    };

    document.getElementById('skipWhisper').onclick = () => {
      if (recorder && recorder.state === 'recording') {
        recorder.stop();
      }
      document.getElementById('recStatus').textContent = 'Voice recording skipped.';
      whisperActive = false;
      audioBlob = null;
    };

    document.getElementById('finalForm').onsubmit = async (e) => {
      e.preventDefault();
      // Stop recording if still running
      if (recorder && recorder.state === 'recording') {
        await new Promise(resolve => {
          recorder.onstop = resolve;
          recorder.stop();
        });
      }

      // Prepare form data (fields + audio)
      const formData = new FormData(document.getElementById('finalForm'));
      if (audioBlob) {
        formData.append('audio', audioBlob, 'recording.webm');
      }

      // Submit to your backend route (update if needed)
      const resp = await fetch('/api/whisper-transcribe', {
        method: 'POST',
        body: formData
      });
      const result = await resp.json();
      document.getElementById('recStatus').textContent = result.transcript
        ? 'Transcription: ' + result.transcript
        : 'Audio submitted!';

      // Redirect, close, or show success as needed
      // window.location.href = 'index.html'; // Optionally redirect
    };
  </script>
</body>
</html>

